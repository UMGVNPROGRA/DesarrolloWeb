@page "/display"
@using HospitalQueueSystem.Models
@implements IDisposable

<div class="display-container">
    <div class="display-header">
        <h1>🏥 HOSPITAL - SISTEMA DE TURNOS</h1>
        <div class="current-time">@currentTime.ToString("dd/MM/yyyy HH:mm:ss")</div>
    </div>

    <div class="turnos-grid">
        @foreach (var turno in turnosActivos)
        {
            <div class="turno-display-card @GetDisplayClass(turno.Estado)">
                <div class="clinica-name">@turno.ClinicaNombre</div>
                <div class="turno-number">@turno.NumeroTurno</div>
                <div class="paciente-name">@turno.PacienteNombre</div>
                <div class="turno-status">@GetStatusText(turno.Estado)</div>
            </div>
        }
    </div>

    @if (!turnosActivos.Any())
    {
        <div class="no-turnos-message">
            <h2>📭 No hay turnos activos en este momento</h2>
            <p>Por favor espere a ser llamado</p>
        </div>
    }
</div>

@code {
    private List<DisplayTurno> turnosActivos = new();
    private Timer? timer;
    private DateTime currentTime = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await CargarTurnos();

        // Actualizar cada 10 segundos
        timer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                currentTime = DateTime.Now;
                await CargarTurnos();
                StateHasChanged();
            });
        }, null, 0, 10000);
    }

    private async Task CargarTurnos()
    {
        try
        {
            var httpClient = new HttpClient();
            var response = await httpClient.GetFromJsonAsync<List<DisplayTurno>>("https://localhost:7000/api/turnos/display");
            turnosActivos = response ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando turnos: {ex.Message}");
            turnosActivos = new();
        }
    }

    private string GetDisplayClass(string estado) => estado switch
    {
        "Llamado" => "llamado",
        "EnAtencion" => "en-atencion",
        _ => "pendiente"
    };

    private string GetStatusText(string estado) => estado switch
    {
        "Llamado" => "📢 POR FAVOR ACERCARSE",
        "EnAtencion" => "✅ EN ATENCIÓN",
        _ => "⏳ EN ESPERA"
    };

    public void Dispose()
    {
        timer?.Dispose();
    }

    public class DisplayTurno
    {
        public string ClinicaNombre { get; set; } = string.Empty;
        public int NumeroTurno { get; set; }
        public string PacienteNombre { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
    }
}